@model List<Part1ex.Models.Calculations>

    <a class="btn btn-primary" href="@Url.Action("CoordinatorDashboard","Home")"> Back to Dashboard</a>

<div class="container">


<br />
	<h2 class="dashboard-heading">Submitted claims :</H2>


    @if (!Model.Any())
    {
        <div class="alert alert-info">No claims submitted yet.</div>
    }
    else
    {
        var pendingClaims = Model.Where(c => c.ClaimStatus == "Pending").ToList();
        var verifiedClaims = Model.Where(c => c.ClaimStatus == "Verified").ToList();//awaiting manager approval.
        var deniedClaims = Model.Where(c => c.ClaimStatus == "Denied").ToList();
        var approvedClaims = Model.Where(c => c.ClaimStatus == "Approved").ToList(); 

        <!-- Pending / New Claims -->
        <h3>New Claims to Verify (@pendingClaims.Count)</h3>
        @if (pendingClaims.Any())
        {
            <table class="table table-warning">
                <thead>
                    <tr>
                        <th>Claim ID</th>
                        <th>Lecturer</th>
                        <th>Hours Worked</th>
                        <th>Hourly Rate</th>
                        <th>Total Amount</th>
                        <th>Documents</th>
                        <th>Claim Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var claim in pendingClaims)
                    {
                        <tr>
                            <td>@claim.claimid</td>
                            <td>@claim.Lecturer</td>
                            <td>@claim.HoursWorked</td>
                            <td>R @claim.HourlyRate</td>
                            <td>R @claim.TotalAmount</td>
                            <td>@(claim.DocumentsUploaded ?? "None")</td>
                            <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                            <td><span class="badge badge-warning">@claim.ClaimStatus</span></td>
                            <td>
                                <button class="btn btn-success btn-sm approve-claim-btn" data-claimid="@claim.claimid">
                                    Verify
                                </button>
                                <button class="btn btn-danger btn-sm reject-claim-btn" data-claimid="@claim.claimid">
                                    Deny
                                </button>
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        
        }
        else
        {
            <p class="alert alert-info">No new claims to verify.</p>
        }

        <!-- Verified / awaiting managers approval Claims -->
        <h3>Verified Claims (@verifiedClaims.Count)</h3>
        @if (verifiedClaims.Any())
        {
            <table class="table table-success">
                <thead>
                    <tr>
                        <th>Claim ID</th>
                        <th>Lecturer</th>
                        <th>Hours Worked</th>
                        <th>Hourly Rate</th>
                        <th>Total Amount</th>
                        <th>Documents</th>
                        <th>Claim Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var claim in verifiedClaims)
                    {
                        <tr>
                            <td>@claim.claimid</td>
                            <td>@claim.Lecturer</td>
                            <td>@claim.HoursWorked</td>
                            <td>R @claim.HourlyRate</td>
                            <td>R @claim.TotalAmount</td>
                            <td>@(claim.DocumentsUploaded ?? "None")</td>
                            <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                            <td><span class="badge badge-info">@claim.ClaimStatus</span></td>
                            <td><span>Checked</span></td>
                        </tr>
                    }
                </tbody>
            </table>
}
        else
        {
            <p class="alert alert-info">No verified claims yet.</p>
        }

         <!-- Approved Claims -->
    <h3>Approved Claims (@approvedClaims.Count)</h3>
    @if (approvedClaims.Any())
    {
        <table class="table table-success">
            <thead>
                <tr>
                    <th>Claim ID</th>
                    <th>Lecturer</th>
                    <th>Hours Worked</th>
                    <th>Hourly Rate</th>
                    <th>Total Amount</th>
                    <th>Documents</th>
                    <th>Claim Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in approvedClaims)
                {
                    <tr>
                        <td>@claim.claimid</td>
                        <td>@claim.Lecturer</td>
                        <td>@claim.HoursWorked</td>
                        <td>R @claim.HourlyRate</td>
                        <td>R @claim.TotalAmount</td>
                        <td>@(claim.DocumentsUploaded ?? "None")</td>
                        <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                        <td><span class="badge badge-primary">@claim.ClaimStatus</span></td>
                        <td><span>Checked</span></td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="alert alert-info">No approved claims yet.</p>
    }



        <!-- Denied Claims -->
        <h3>Denied Claims (@deniedClaims.Count)</h3>
        @if (deniedClaims.Any())
        {
            <table class="table table-danger">
                <thead>
                    <tr>
                        <th>Claim ID</th>
                        <th>Lecturer</th>
                        <th>Hours Worked</th>
                        <th>Hourly Rate</th>
                        <th>Total Amount</th>
                        <th>Documents</th>
                        <th>Claim Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var claim in deniedClaims)
                    {
                        <tr>
                            <td>@claim.claimid</td>
                            <td>@claim.Lecturer</td>
                            <td>@claim.HoursWorked</td>
                            <td>R @claim.HourlyRate</td>
                            <td>R @claim.TotalAmount</td>
                            <td>@(claim.DocumentsUploaded ?? "None")</td>
                            <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                            <td><span class="badge badge-danger">@claim.ClaimStatus</span></td>
                            <td><span>Checked</span></td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="alert alert-info">No denied claims.</p>
        }

        @if (TempData["Message"] != null)
        {
            <p style="color:green">@TempData["Message"]</p>
        }
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Approve claim
           document.querySelectorAll(".verify-claim-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const claimId = this.dataset.claimid;
                    const result = await Swal.fire({
                        title: "Confirm Verification",
                        text: `Are you sure you want to verify claim #${claimId}?`,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, verify it",
                        cancelButtonText: "Cancel",
                        reverseButtons: true
                    });


                    if (!result.isConfirmed) return;

                    try {
                        const response = await fetch(`/Home/ApproveClaimManager`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            },
                            body: `claimid=${claimId}`,
                            credentials: 'include'
                        });
                        const data = await response.json();
                        if (data.success) {
                            await Swal.fire("Approved!", data,message , "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", data.message, "error");
                        }
                    } catch (err) {
                        Swal.fire("Error", "Something went wrong.", "error");
                    }
                });
            });

            // Reject claim
           document.querySelectorAll(".deny-claim-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const claimId = this.dataset.claimid;
                    const result = await Swal.fire({
                        title: "Confirm Denial",
                        text: `Are you sure you want to deny claim #${claimId}?`,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, deny it",
                        cancelButtonText: "Cancel",
                        reverseButtons: true
                    });


                    if (!result.isConfirmed) return;

                    try {
                        const response = await fetch(`/Home/RejectClaimManager`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            },
                            body: `claimid=${claimId}`,
                              credentials: 'include'
                        });
                        const data = await response.json();
                        if (data.success) {
                            await Swal.fire("Denied!", data,message  , "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", data.message, "error");
                        }
                    } catch (err) {
                        Swal.fire("Error", "Something went wrong.", "error");
                    }
                });
            });

        });
    </script>
}
