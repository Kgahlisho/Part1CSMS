@model List<Part1ex.Models.Calculations>



    <a class="btn btn-primary" href="@Url.Action("ManagerDashboard","Home")"> Back to Dashboard</a>

<div class="container mt-4">


<br />
	<h2 class="dashboard-heading">Verified claims awaiting approval :</H2>


@if (Model == null || !Model.Any(c => c.ClaimStatus =="Verified"))
{
	<div class="alert alert-info">No claims awaiting approval have been submitted yet.</div>

}
else
{
	<table class="table table-warning">
        <thead>
            <tr>
                <th>Claim id</th>
                <th>Lecturer name</th>
                <th>Verified By</th>
                <th>Hours Worked</th>
                <th>Hourly Rate</th>
                <th>Total Amount</th>
                <th>Documents</th>
                <th>Claim date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var claim in Model.Where(c => c.ClaimStatus == "Verified"))
        {
            <tr>
                <td>@claim.claimid</td>
                <td>@claim.Lecturer</td>
                <td>@(string.IsNullOrEmpty(claim.VerifiedBy) ? "-" : claim.VerifiedBy)</td>
                <td>@claim.HoursWorked</td>
                <td>R @claim.HourlyRate</td>
                <td>R @claim.TotalAmount</td>
                <td>@(claim.DocumentsUploaded ?? "None")</td>
                <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                <td><span class="badge badge-info">@claim.ClaimStatus</span></td>
                <td>
                    <button class="btn btn-success btn-sm approve-claim-btn" data-claimid="@claim.claimid">
                        Approve
                    </button>
                     <button class="btn btn-danger btn-sm reject-claim-btn" data-claimid="@claim.claimid">
                        Reject
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<br/>



 <h2 class="dashboard-heading">Processed claims (Approved / Denied):</h2>

@if (Model == null || !Model.Any(c => c.ClaimStatus == "Approved" || c.ClaimStatus == "Denied"))
{
        <div class="alert alert-info">No processed claims yet.</div>
    }
    else
    {
        <table class="table table-secondary">
            <thead>
                <tr>
                   <th>Claim ID</th>
                <th>Lecturer</th>
                <th>Verified By</th>
                <th>Hours Worked</th>
                <th>Hourly Rate</th>
                <th>Total Amount</th>
                <th>Documents</th>
                <th>Claim Date</th>
                <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model.Where(c => c.ClaimStatus == "Approved")) 
                {
            <tr>
               <td>@claim.claimid</td>
                    <td>@claim.Lecturer</td>
                         <td>@(string.IsNullOrEmpty(claim.VerifiedBy) ? "-" : claim.VerifiedBy)</td>
                    <td>@claim.HoursWorked</td>
                    <td>R @claim.HourlyRate</td>
                    <td>R @claim.TotalAmount</td>
                    <td>@(claim.DocumentsUploaded ?? "None")</td>
                    <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                    <td>
                        <span class="badge @(claim.ClaimStatus == "Approved" ? "badge-success" : "badge-danger")">
                            @claim.ClaimStatus
                        </span>
                    </td>
            </tr>
        }
        </tbody>
    </table>
}
<h2 class="dashboard-heading">Denied Claims</h2>
    @if (Model == null || !Model.Any(c => c.ClaimStatus == "Denied"))
    {
        <div class="alert alert-info">No denied claims yet.</div>
    }
    else
    {
        <table class="table table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Claim ID</th>
                    <th>Lecturer</th>
                    <th>Verified By</th>
                    <th>Total Amount</th>
                    <th>Documents</th>
                    <th>Claim Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model.Where(c => c.ClaimStatus == "Denied"))
                {
                    <tr>
                        <td>@claim.claimid</td>
                    <td>@claim.Lecturer</td>
                    <td>@(string.IsNullOrEmpty(claim.VerifiedBy) ? "-" : claim.VerifiedBy)</td>
                    <td>R @claim.TotalAmount</td>
                    <td>@(claim.DocumentsUploaded ?? "None")</td>
                    <td>@claim.ClaimDate.ToString("yyyy-MM-dd")</td>
                    <td><span class="badge bg-danger">@claim.ClaimStatus</span></td>
                    </tr>
                }
            </tbody>
        </table>
    }
                


	@if (TempData["Message"] != null)
    {
        <p style="color:green">@TempData["Message"]</p>
    }
}
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Approve claim
            document.querySelectorAll(".approve-claim-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const claimId = this.dataset.claimid;

                    const result = await Swal.fire({
                        title: "Confirm Approval",
                        text: `Are you sure you want to approve claim #${claimId}?`,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, approve it",
                        cancelButtonText: "Cancel",
                        reverseButtons: true
                    });

                    if (!result.isConfirmed) return;

                    try {
                        const response = await fetch(`/Home/ApproveClaimManager`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `claimid=${claimId}`,
                            credentials: 'same-origin'
                        });

                        const data = await response.json();
                        if (data.success) {
                            await Swal.fire("Approved!", data.message, "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", data.message, "error");
                        }
                    } catch (err) {
                        console.error("Fetch error (approve):", err);
                        Swal.fire("Error", "Something went wrong. Check console for details.", "error");
                    }
                });
            });

            // Reject claim
            document.querySelectorAll(".reject-claim-btn").forEach(btn => {
                btn.addEventListener("click", async function () {
                    const claimId = this.dataset.claimid;

                    const result = await Swal.fire({
                        title: "Confirm Rejection",
                        text: `Are you sure you want to deny claim #${claimId}?`,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, deny it",
                        cancelButtonText: "Cancel",
                        reverseButtons: true
                    });

                    if (!result.isConfirmed) return;

                    try {
                        const response = await fetch(`/Home/RejectClaimManager`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `claimid=${claimId}`,
                            credentials: 'same-origin'
                        });

                        const data = await response.json();
                        if (data.success) {
                            await Swal.fire("Denied!", data.message, "success");
                            location.reload();
                        } else {
                            Swal.fire("Error", data.message || "Operation failed.", "error");
                          }
                        }catch (err) {
                          console.error("Fetch error:", err);
                          Swal.fire("Error", "A network or server error occurred.", "error");
                        }
                });
            }); 
        });
    </script>
}
